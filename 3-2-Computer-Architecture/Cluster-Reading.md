# 集群系统读书报告

> 2017/6/6
>
> 本文为 计算机系统架构 集群系统专题 读书报告

[heading-numbering]

## [no-number] [no-toc] 目录

[TOC]

## 集群的定义

**计算机集群**（简称 **集群**）是通过一组松散集成的计算机软件、硬件连接起来高度紧密地协作完成计算工作的计算机系统。集群系统对程序员透明，也就是说，可以被看作是 **一台计算机**。[cluster-wiki]

每个计算机叫做一个 **计算节点**，都处理相同的任务，并由统一的软件进行调度。通常，每个节点上运行各自的操作系统，并通过局域网相连接。一般的，每个节点会使用相同的硬件和操作系统，以便于使用相同的配置。

集群系统常常被用于 **分布式计算**，即组合多个低成本微处理器，通过高速网络连接，使用软件调度这些机器进行协同工作。

目前由于许多操作系统对集群有很好的支持，集群系统可以很方便的搭建。

GNU/Linux 支持了很多的集群软件，例如 distcc, MPICH 等应用集群， Linux 虚拟服务器, Linux-HA 等高可用性集群，MOSIX, LinuxPMI, Kerrighed, OpenSSI 等单系统镜像集群（一个操作系统同时调度多个同构的计算节点）。[cluster-wiki]

微软的 Windows 操作系统 Windows Server 2003 开始支持了高性能计算集群，例如 作业调度、MSMPI 库和集群管理工具。[cluster-wiki]

[sec|集群实例 —— Linux 虚拟服务器] 将以 Linux 虚拟服务器 为例，简单的介绍集群系统的示例。

## 集群的分类

计算机集群按功能、结构可以分为三类 [cluster-wiki-zh]：

- 高可用性集群 (high availability cluster)
- 负载均衡集群 (load balancing cluster)
- 高性能计算集群 (high performance cluster)

### 高可用性集群

高可用性集群指的是：

- 当一个节点出现故障时，集群系统会 **检测到节点失效**，并将节点上的任务转移到其他正常工作的节点上，从而保证系统的正常运行。
- 当一个节点从故障中恢复后，集群系统会自动 **检测到节点上线**，并将其纳入正常节点列表，平滑的加入系统。

对于节点的失效和恢复，对系统外部是不可见的（透明的），这样不会影响系统的运行过程（热调整）。

### 负载均衡集群

负载均衡集群指的是：通过一个或多个 **前端负载均衡机器**，将负载合理地分发到 **后端的工作服务器** 上，从而实现集群系统的高效利用。

由于负载均衡集群和高可用性集群具有相似之处，所以一般的集群系统会同时支持这两个功能。

例如，[sec|集群实例 —— Linux 虚拟服务器] 介绍的 Linux 虚拟服务器就是一个 Linux 操作系统提供的负载均衡的软件。

### 高性能计算集群

高性能计算集群指的是：将计算任务分配到不同的计算节点，计算节点并行的进行计算，从而提高计算能力。这样的集群一般用于科学技术等领域。

为了实现高性能计算，集群往往需要部署响应的软件或使用特定的技术，从而实现各个节点之间的协同调度和信息传递（例如，map-reduce 分布式计算 或 MPI 科学计算）。

## 集群的优势

随着社会的发展，人们对计算机处理能力的需求越来越大，原始的单个计算机已不能满足需求。为了解决这个问题，人们提出了 大规模并行处理器 (MPP)、对称多处理器 (SMP)、Cache 一致性的非统一内存访问 (CC-NUMA)、分布式共享存储多处理机 (DSM)、集群系统 (Cluster) 等技术。

而目前集群技术凭借着 低成本、高可扩展性、高可用性、高性能 等优势，被广泛的应用于各个领域。

### 低成本

相对于单独使用集群内部的一个机器，使用集群可以大大提高系统的性能和可用性。而如果要让一个机器达到同样的计算速度和可用性，那么成本会非常的高（例如超级计算机）。另外，单个计算机的可靠性，往往不如多个计算机可靠。所以，为了降低成本，集群通过 **协调** 多个低性能的计算机，实现和高性能、高成本计算机一样的效果，并对集群的使用者透明。

另外，集群系统具有很好的 **水平可扩展性**。当业务规模扩大时，我们只需要添加相同配置的机器，就可以增大集群的计算能力；而不需要升级已有的机器的配置，带来更高的成本。

软件方面，在市场上有许多的开源软件，可以很好的帮助我们构建集群系统。使用这些开源软件，避免了为购买的硬件定制特定软件、系统的问题，进而降低了集群系统的成本。

### 高可用性

单个计算机往往会出现宕机等问题，而集群系统通过部署相同的功能的 **冗余** 计算节点实现高可用性。这些冗余的计算节点，对外提供相同的功能；当一个节点出现故障时，另一个节点会代替它对外提供相同的服务，从而保障了系统的可靠性。

另外，由软件对这些节点进行调度，可以实现 **负载均衡** 的功能。例如，一个 Web 服务器接受对外请求，它可以将请求分发给各个应用服务器。而每个应用服务器会统计自身的负载情况，并向 Web 服务器汇报；利用这些信息，Web 服务器会根据应用服务器的负载情况，合理地分配资源，转发请求。对于出现故障的应用服务器，Web 服务器不会将服务发送到它那里，直到它恢复后才会使用。

### 高性能

集群系统相对于单个计算机，往往有很好的并行性。利用这个优势，我们可以实现高性能计算。例如，我们可以使用分布式计算技术（例如 map-reduce），将任务分发到各个计算节点，让这些节点同时计算，再将计算的结果合并，最终得到我们需要的结果。

## 影响集群计算能力的主要因素

集群的高性能优势主要得益于它的并行性。而目前影响集群计算能力的主要因素有 [parallel-factor]：

- 节点传递信息的网络性能
- 并行算法的设计
- 节点之间的负载平衡

### 网络性能

在分布式计算中，节点之间需要交换数据；而网络性能的优劣决定了交换数据的速度。一般的，网络交换数据会占用上百个或上千个时钟周期，而一次运算仅是几个时钟周期，所以网络时延成为了集群高性能计算中的一个重要开销。

而 [sec|集群的现状] 提到，使用更好的底层互连网络，可以大大提升网络性能，从而提高集群计算能力。

### 并行算法

算法的设计往往是高性能计算的设计难点，而并行算法的优劣会极大的影响集群系统的高性能计算能力。所以，针对于特定的问题，为集群系统设计更好的并行算法，可以大大的提升集群系统的计算能力。

### 负载平衡

在 [sec|负载均衡集群] 描述了，并行计算的过程中，一个大任务会往往会分成若干个小任务，并分发到不同的机器上完成。为了提升系统的整体性能，负载均衡就是完成合理分发任务过程的关键。

针对这个问题，许多学者都提出了不同场景下的负载均衡算法。良好的算法应该考虑：特殊的网络结构、交互用户的介入、后台进程的运行等因素，从而实现更合理的动态调度。

## 集群的现状

随着集群的不断完善和发展，集群技术受到了越来越多学者的关注。国内知名集群技术专家，清华大学教授郑纬民曾指出：集群系统成为构建高性能计算系统的主流方式。[current-challenge]

由于具有低成本、高性能和良好的可扩展性，集群系统已经日益成为构建高性能计算系统的主要方式。集群系统的一个重要特点是尽量使用商用部件以降低成本。用来构建集群系统的各个部件，包括计算结点和通信网络，都可以在市场上很方便地得到而无需专门定制。而使用开放源代码的 Linux 操作系统和其他软件工具的集群系统更可以进一步降低系统的软件成本。

目前，不只是大公司和研究部门在使用集群系统，许多的中小规模公司和单位，也已经构建了自己的集群系统。

如今，高性能计算的研究领域已经不限于科学计算本身。大规模网络服务等商业计算也是新兴的高性能计算研究和应用方向。Web 服务、视频点播服务、数据库服务等目前流行的网络应用对数据存储容量、访问能力和管理方式提出越来越高的要求，这些都是传统的 SCSI 硬盘、RAID 存储系统无法胜任的。高容量、高性能、可靠和易管理的存储技术研究成为当前热点。

为了解决高性能存储的问题，存储区域网络 (SAN) 被广泛的应用于集群系统中。存储区域网络是一种新兴的网络存储技术，它将存储子系统与服务器分离，利用高速网络进行块数据的传输，实现存储系统的可扩展性和高性能。

连接集群系统底层的互连网络，对集群系统的整体性能有决定性的作用，因此一直是学术界和工业界所关注的热点。Myrinet、Quadrics、SCI 和 InfiniBand 等商业化高性能集群通信网络，以更高的带宽和更小的传输延时，为高性能集群系统提供了多样化的选择。

## 集群实例 —— Linux 虚拟服务器

**Linux 虚拟服务器** 是一个由 Linux 操作系统内核提供的虚拟服务器集群系统。该项目最早在 1998 年由章文嵩发起，至今得到广泛的应用。利用 Linux 虚拟服务器技术，可以搭建一个高可用性的负载均衡服务器集群，并对最终用户透明。 [lvs-wiki]

![Virtual Server](http://www.linuxvirtualserver.org/VirtualServer.png)

[align-center]

图 [graph||virtual-server] - 虚拟服务器示意图 [lvs-org]

服务器之间和负载均衡服务器之间可以通过局域网或广域网相连接。负载均衡服务器通过分发请求到不同的服务器上，实现并行的服务处理。对外看来，就相当于是在同一个 IP 地址上完成了对外的服务。请求分发可以使用 IP 负载均衡技术或应用层的负载均衡技术实现。

利用 Linux 虚拟服务器，可以实现：

- 可扩展性：在集群中添加或删除节点，对上层是透明的。
- 高可用性：可以实时检测到守护进程或节点的状态改变，并自动的重新配置系统。

如官方网站是描述的，Linux 虚拟服务器的设计初衷是：

> 使用集群技术，搭建一个高性能、高可用性的 Linux 服务器，提供良好的可扩展性、可靠性、可服务性。[lvs-org]

### 基本架构

Linux 虚拟服务器抽象上分为三个层次 [lvs-paper]：

- 负载均衡服务器
- 实际服务器
- 存储服务系统

#### 负载均衡服务器

负载均衡处在整个集群的最上层，负责接受对外服务。也就是说，在集群的外部看来，整个集群就相当于是一台具有一个 IP 地址的虚拟服务器。而在集群内部，负载均衡服务器相当于是整个集群系统的协调者，负责将对外的服务分发到具体的实际服务器上，再将实际服务器返回的结果发回外部。

#### 实际服务器

实际服务器处在整个系统的中间层次：一方面负责接受负载均衡传入的数据，并将计算好的数据返回给负载均衡；另一方面，通过访问最底层的存储服务系统，实现统一的数据存储访问。对于单个服务器往往不能达到很高的吞吐量，但是多个服务器同时处理业务，将可以得到几乎和机器数目成正比的吞吐量。

根据不同的业务需求，实际服务器处理不同的业务逻辑。例如，[sec|Web 服务器集群实例] 展示了如何配置基于 Linux 虚拟服务器的 Web 服务器集群，实现日常使用的 HTTP 服务；[sec|MySQL 集群实例] 介绍了如何利用 MySQL Cluster 和 Linux 虚拟服务器，搭建 MySQL 数据库集群环境，实现高可用性的数据库服务。

#### 存储服务系统

存储服务系统处在整个系统的最底层，属于是 Linux 虚拟服务器的扩展，即不是必须的部分。利用整个存储服务系统，我们可以实现集群内节点的统一的文件访问 —— 相当于对所有的实际服务器来说，就好像是访问同一个文件系统，而不是多个文件系统。在存储服务系统内部，系统支持了文件系统的 文件锁机制、负载均衡、容错、事务处理 等功能。

为了实现高性能、高吞吐的 I/O，这一层可以使用 存储区域网络 (SAN，[sec|集群的现状]) 技术实现。

### 工作原理

目前，Linux 虚拟服务器支持三种基于 IP 负载均衡的工作方式 [lvs-how]：

- 地址转换 (NAT) 方式：通过交换机或集线器连接第一第二层，为负载均衡服务器分配固定的 IP，实际服务器分配私有的地址，两者通过 NAT 方式通信。只需要使用的服务器支持 TCP/IP 协议就可以使用。
- IP 隧道方式：利用 IP 隧道直接连接外部请求和第二层的实际服务器，从而避免了 NAT 带来的开销，解决负载均衡服务器吞吐量瓶颈的问题。
- 直接路由方式：修改 IP 的路由信息，直接将外部请求路由到实际服务器上。

在负载均衡算法上，Linux 虚拟服务器目前支持四种负载均衡算法 [lvs-paper]：

- 轮转调度 (Round Robin Scheduling)：以一个固定的周期（时间片）切换目标实际服务器，不考虑当前目标的负载情况。（基于每个服务请求的计算量基本相同、每个实际服务器负载能力基本相同的假设）
- 加权轮转调度 (Weighted Round Robin Scheduling)：和轮转调度类似，为负载能力较强的实际服务器分配更多的时间片，并使用轮转的方式实现对目标实际服务器的调度。（仍基于每个服务请求的计算量基本相同的假设）
- 最少连接调度 (Least Connection Scheduling)：每次将服务请求分配到连接最少的机器上，并在连接数相同时，随机使用可用的机器。（基于每个实际服务器负载能力基本相同的假设）
- 加权最小连接调度 (Weighted Least Connection Scheduling)：根据实际服务器的实际负载能力和连接数，求出一个权重，即连接数小、负载能力强的服务器权重大，并每次选择最大权重的实际服务器进行分配。

四种算法并没有明确的好坏，需要根据具体的需求和实际机器的配置进行选择。

### Web 服务器集群实例

传统的 Web 服务器集群和 [sec|基本架构] 介绍的三层架构基本一致，包括了前端负载均衡、后端 Web 服务器和统一的存储服务系统。下图展示了整个系统的架构示意图。

![Web Cluster](http://kb.linuxvirtualserver.org/images/e/ea/Web-cluster.jpg)

[align-center]

图 [graph||web-cluster] - Web 服务器集群架构 [lvs-web-cluster]

上图同时也描述了一个 Web 请求的基本流程：

- 用户通过互联网或内网，将请求发到一个虚拟 IP 地址
- 这个虚拟 IP 路由到前端的负载均衡
- 负载均衡通过负载均衡算法，将请求分发到具体的后端 Web 服务器上
- 后端 Web 服务器可以统一的访问一个存储服务系统（由对应的 Web Master 管理）
- 后端 Web 服务器直接生成响应，并返回用户

### MySQL 集群实例

MySQL 自带的集群功能已经实现了高可用性，但 SQL 节点无法对外负载均衡。为了实现负载均衡，我们可以用在 SQL 节点上使用 Linux 虚拟服务器。下图展示了传统的 MySQL 集群架构。

[align-center]

[img=max-width:80%]

![MySQL Cluster](http://kb.linuxvirtualserver.org/images/c/c7/Mysql-cluster-components-1.png)

[align-center]

图 [graph||mysql-cluster] - MySQL 集群架构 [lvs-mysql-cluster]

图中描述的架构分为三层：

- 第一层是数据库系统对应用程序开放的接口（不同的 API）
- 第二层是 SQL 节点，即具体的 MySQL 服务器
- 第三层是数据节点，即对应到实际的存储

如果需要引入 Linux 虚拟服务器技术，我们只需要在第一第二层之间加入前端负载均衡。通过前端负载均衡，我们可以实现对 SQL 节点的负载均衡。[mysql-cluster-setup]

## 参考文献 [no-number]

- [cluster-wiki]: Computer cluster. Wikipedia. https://en.wikipedia.org/wiki/Computer_cluster
- [cluster-wiki-zh]: 计算机集群. 维基百科. https://zh.m.wikipedia.org/wiki/计算机集群
- [parallel-factor]: 旷海兰, 刘新华. 高性能计算与集群系统. 衡阳师范学院学报. 2005.
- [current-challenge]: 郑纬民. 集群系统的现状与挑战. 计算机教育. 2004.
- [lvs-wiki]: Linux虚拟服务器. 维基百科. https://zh.m.wikipedia.org/wiki/Linux%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8
- [lvs-org]: The Linux Virtual Server - Linux Server Cluster for Load Balancing. Linux Virtual Server. http://www.linuxvirtualserver.org/
- [lvs-paper]: 罗秉安, 张立臣. 集群系统的技术与应用. 微型电脑应用. 2003.
- [lvs-how]: How virtual server works. Linux Virtual Server. http://www.linuxvirtualserver.org/how.html
- [lvs-web-cluster]: Building Scalable Web Cluster using LVS. LVSKB. http://kb.linuxvirtualserver.org/wiki/Building_Scalable_Web_Cluster_using_LVS
- [lvs-mysql-cluster]: Building MySQL Cluster using LVS. LVSKB. http://kb.linuxvirtualserver.org/wiki/Building_MySQL_Cluster_using_LVS
- [mysql-cluster-setup]: 利用 MySQL Cluster 7.0 + LVS 搭建高可用环境. iMySQL | 老叶茶馆. http://www.imysql.cn/2009/05/13/build_ha_envirenment_using_mysql_cluster7_and_lvs.html